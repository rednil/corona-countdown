<html lang="de">
  <head>
    <meta http-equiv="refresh" content="3600">
    <meta charset="utf-8">
    <title>Corona Countdown</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A countdown to SARS-CoV2 herd immunity in germany">
    <style>
      h1 {
        margin-block-end: 0;
      }
      progress {
        width: 100%;
        margin: 1em 0;
      }
      h1:not(.title), .label, .percent {
        color: grey;
      }
      .title, #countdown {
        font-size: xx-large;
        font-weight: bold;
      }
      body, .content {
        display: flex;
        flex-direction: column;
      }
      body {
        justify-content: space-between;
        height: 100%;
      }
      section, .source {
        margin: auto;
        text-align: center;
      }
      .data {
        font-size: xx-large;
        font-weight: bold;
      }
    </style>
  </head>
<body>
  <div class="content">
    <section>
      <h1 class="title">Corona Countdown</h1>
      <progress></progress>
      <div>
        <div class="data" id="countdown"></div>
        <div class="label">(Sekunden bis zur Herdenimmunität)</div>
      </div>
    </section>
    <section>
      <h1>Erstimpfungen</h1>
      <div>
        <div class="data" id="firstShots"></div>
        <div class="percent" id="firstShotPercent"></div>
      </div>
    </section>
    <section>
      <h1>Zweitimpfungen</h1>
      <div>
        <div class="data" id="secondShots"></div>
        <div class="percent" id="secondShotPercent"></div>
      </div>
    </section>
    <section>
      <h1>Herdenimmunität (66%)</h1>
      <div>
        <div class="data" id="herdImmunityDate"></div>
        <div class=label>(Beim Durchschnittstempo der letzten 7 Tage)</div>
      </div>
    </section>
  </div>
  <div class="source">Quelle: <a href="https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquotenmonitoring.html">RKI</a>, letztes Update: <span id="lastUpdate"></span></div>
  <script>
    const data = {"entries":[["2020-12-27",24249,0],["2020-12-28",19644,0],["2020-12-29",42921,0],["2020-12-30",57370,0],["2020-12-31",37912,0],["2021-01-01",30581,0],["2021-01-02",44884,0],["2021-01-03",24545,0],["2021-01-04",48597,0],["2021-01-05",50903,0],["2021-01-06",56083,0],["2021-01-07",57426,0],["2021-01-08",57853,0],["2021-01-09",53451,0],["2021-01-10",32198,0],["2021-01-11",65629,0],["2021-01-12",79980,0],["2021-01-13",93763,0],["2021-01-14",99341,45],["2021-01-15",89032,218],["2021-01-16",54375,298],["2021-01-17",30240,11182],["2021-01-18",51565,13295],["2021-01-19",56772,20400],["2021-01-20",64777,32164],["2021-01-21",0,0],["2021-01-22",0,0],["2021-01-23",0,0],["2021-01-24",0,0],["2021-01-25",0,0],["2021-01-26",0,0],["2021-01-27",0,0],["2021-01-28",0,0],["2021-01-29",0,0],["2021-01-30",0,0],["2021-01-31",0,0]]}
    function rate(shot, days) {
      return data.entries.slice(-days).reduce((acc, entry) => acc + entry[shot], 0) / days
    }
    function format(number) {
      return Math.round(number).toLocaleString()
    }
    function percent(number) {
      return Math.round(number*10000)/100 + '%'
    }
    function insert(id, str) {
      document.querySelector(id).textContent = str
    }
    function update() {
      const daysSinceLastEntry = (new Date() - lastEntry) / millisecondsPerDay - 1
      const firstShots = data.total[0] + daysSinceLastEntry * firstShotRate
      const secondShots = data.total[1] + daysSinceLastEntry * secondShotRate
      let daysToGo = (required - firstShots) / firstShotRate + 21
      const herdImmunityDate = new Date()
      herdImmunityDate.setDate(herdImmunityDate.getDate() + daysToGo)
      progressNode.value = secondShots/required
      insert('#herdImmunityDate', herdImmunityDate.toLocaleDateString())
      insert('#firstShots', format(firstShots))
      insert('#firstShotPercent', `(${percent(firstShots/population)})`)
      insert('#secondShots', format(secondShots))
      insert('#secondShotPercent', `(${percent(secondShots/population)})`)
      insert('#countdown', format(daysToGo * 24 * 60 * 60))
    }
    const lastEntry = new Date(data.entries.slice(-1)[0][0] + ' 00:00:00')
    const lastUpdate = new Date(lastEntry)
    lastUpdate.setDate(lastUpdate.getDate()+1)
    const millisecondsPerDay = 24 * 60 * 60 * 1000
    const progressNode = document.querySelector('progress')
    const firstShotRate = rate(1, 7)
    const secondShotRate = rate(2, 7)
    const firstShotInterval = millisecondsPerDay / firstShotRate
    const secondShotInterval = millisecondsPerDay / secondShotRate
    const population = 83100000
    const herdImmunity = 0.66
    const required = population * herdImmunity
    insert('#lastUpdate', lastUpdate.toLocaleDateString())
    update()
    setInterval(update.bind(this), 1000)
  </script>
</body>
